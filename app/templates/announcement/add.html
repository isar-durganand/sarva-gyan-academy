{% extends "base.html" %}
{% block title %}New Announcement{% endblock %}
{% block page_title %}New Announcement{% endblock %}

{% block content %}
<!-- Quill Editor CSS -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<style>
    /* Quill Editor */
    .editor-wrapper {
        margin-bottom: 20px;
    }

    .ql-container {
        border: 1px solid var(--border-color) !important;
        border-top: none !important;
        border-radius: 0 0 8px 8px;
        min-height: 200px;
        background: var(--bg-input);
    }

    .ql-toolbar {
        border: 1px solid var(--border-color) !important;
        border-radius: 8px 8px 0 0;
        background: var(--bg-table-stripe);
    }

    .ql-editor {
        min-height: 200px;
        font-size: 14px;
        line-height: 1.6;
        color: var(--text-primary);
    }

    .ql-editor.ql-blank::before {
        color: var(--text-muted);
        font-style: normal;
    }

    [data-theme="dark"] .ql-stroke {
        stroke: var(--text-secondary) !important;
    }

    [data-theme="dark"] .ql-fill {
        fill: var(--text-secondary) !important;
    }

    [data-theme="dark"] .ql-picker {
        color: var(--text-secondary) !important;
    }

    [data-theme="dark"] .ql-picker-options {
        background: var(--bg-card) !important;
        border-color: var(--border-color) !important;
    }

    /* Image Upload */
    .upload-zone {
        border: 2px dashed var(--border-color);
        border-radius: 10px;
        padding: 40px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        background: var(--bg-table-stripe);
    }

    .upload-zone:hover,
    .upload-zone.dragover {
        border-color: var(--primary);
        background: rgba(99, 102, 241, 0.05);
    }

    .upload-zone i {
        font-size: 48px;
        color: var(--text-muted);
        display: block;
        margin-bottom: 12px;
    }

    .upload-zone h4 {
        font-size: 14px;
        margin: 0 0 4px;
        color: var(--text-primary);
    }

    .upload-zone p {
        font-size: 12px;
        color: var(--text-muted);
        margin: 0;
    }

    .image-preview-box {
        position: relative;
        display: inline-block;
    }

    .image-preview-box img {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }

    .remove-img {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 24px;
        height: 24px;
        background: var(--danger);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Section Headers */
    .section-header {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin: 24px 0 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border-color);
    }

    .section-header:first-child {
        margin-top: 0;
    }

    .section-header i {
        color: var(--primary);
        font-size: 16px;
    }

    /* Checkbox Pills */
    .checkbox-pills {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .checkbox-pill {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 14px;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
    }

    .checkbox-pill:hover {
        border-color: var(--primary);
    }

    .checkbox-pill.active {
        border-color: var(--primary);
        background: rgba(99, 102, 241, 0.1);
        color: var(--primary);
    }

    .checkbox-pill input {
        display: none;
    }

    .checkbox-pill i {
        font-size: 16px;
    }
</style>

<div class="card" style="max-width: 800px;">
    <div class="card-header">
        <h3 class="card-title"><i class="bi bi-megaphone-fill"></i> Create Announcement</h3>
    </div>
    <form method="POST" id="announcementForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="content" id="contentInput">
        <input type="hidden" name="image_url" id="imageUrlInput">

        <div class="card-body">
            <!-- Basic Info -->
            <div class="section-header"><i class="bi bi-info-circle"></i> Basic Information</div>

            <div class="form-group">
                <label class="form-label">Title <span class="required">*</span></label>
                <input type="text" name="title" class="form-control" required placeholder="Enter announcement title">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Type</label>
                    <select name="announcement_type" class="form-control form-select">
                        {% for t in types %}
                        <option value="{{ t }}">{{ t.replace('_', ' ').title() }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select name="priority" class="form-control form-select">
                        {% for p in priorities %}
                        <option value="{{ p }}" {{ 'selected' if p=='NORMAL' }}>{{ p.title() }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Content -->
            <div class="section-header"><i class="bi bi-text-paragraph"></i> Content</div>

            <div class="form-group editor-wrapper">
                <label class="form-label">Content <span class="required">*</span></label>
                <div id="quillEditor"></div>
            </div>

            <!-- Image -->
            <div class="section-header"><i class="bi bi-image"></i> Image (Optional)</div>

            <div class="form-group" id="imageSection">
                <div class="upload-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
                    <i class="bi bi-cloud-arrow-up"></i>
                    <h4>Drop image here or click to upload</h4>
                    <p>PNG, JPG, GIF, WEBP (max 5MB)</p>
                </div>
                <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="uploadFile(this)">
            </div>

            <!-- Target -->
            <div class="section-header"><i class="bi bi-people"></i> Target Audience</div>

            <div class="form-group">
                <label class="form-label">Batch</label>
                <select name="batch_id" class="form-control form-select">
                    <option value="">All Batches</option>
                    {% for batch in batches %}
                    <option value="{{ batch.id }}">{{ batch.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Visible To</label>
                <div class="checkbox-pills">
                    <label class="checkbox-pill active">
                        <input type="checkbox" name="for_students" checked>
                        <i class="bi bi-mortarboard-fill"></i> Students
                    </label>
                    <label class="checkbox-pill active">
                        <input type="checkbox" name="for_teachers" checked>
                        <i class="bi bi-person-badge-fill"></i> Teachers
                    </label>
                    <label class="checkbox-pill">
                        <input type="checkbox" name="for_parents">
                        <i class="bi bi-people-fill"></i> Parents
                    </label>
                </div>
            </div>

            <!-- Scheduling -->
            <div class="section-header"><i class="bi bi-calendar3"></i> Scheduling</div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Publish Date</label>
                    <input type="date" name="publish_date" class="form-control" value="{{ today }}">
                </div>
                <div class="form-group">
                    <label class="form-label">Expiry Date</label>
                    <input type="date" name="expiry_date" class="form-control">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Options</label>
                <div class="checkbox-pills">
                    <label class="checkbox-pill">
                        <input type="checkbox" name="is_pinned">
                        <i class="bi bi-pin-angle-fill"></i> Pin to top
                    </label>
                </div>
            </div>
        </div>

        <div class="card-footer">
            <a href="{{ url_for('announcement.list_announcements') }}" class="btn btn-outline"><i
                    class="bi bi-arrow-left"></i> Cancel</a>
            <button type="submit" class="btn btn-primary"><i class="bi bi-send-fill"></i> Publish</button>
        </div>
    </form>
</div>

<!-- Quill Editor -->
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
<script>
    // Initialize Quill
    var quill = new Quill('#quillEditor', {
        theme: 'snow',
        placeholder: 'Write your announcement...',
        modules: {
            toolbar: [['bold', 'italic', 'underline'], [{ 'list': 'ordered' }, { 'list': 'bullet' }], ['link'], ['clean']]
        }
    });

    // Form submit
    document.getElementById('announcementForm').onsubmit = function (e) {
        var content = quill.root.innerHTML;
        if (quill.getText().trim().length === 0) {
            e.preventDefault();
            alert('Please enter announcement content');
            return false;
        }
        document.getElementById('contentInput').value = content;
    };

    // Checkbox pills
    document.querySelectorAll('.checkbox-pill').forEach(function (pill) {
        pill.onclick = function (e) {
            if (e.target.tagName !== 'INPUT') {
                var cb = this.querySelector('input');
                cb.checked = !cb.checked;
            }
            this.classList.toggle('active', this.querySelector('input').checked);
        };
    });

    // Drop zone
    var dropZone = document.getElementById('dropZone');
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(function (e) {
        dropZone.addEventListener(e, function (ev) { ev.preventDefault(); ev.stopPropagation(); });
    });
    dropZone.addEventListener('dragover', function () { this.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', function () { this.classList.remove('dragover'); });
    dropZone.addEventListener('drop', function (e) {
        this.classList.remove('dragover');
        if (e.dataTransfer.files.length) uploadFile({ files: e.dataTransfer.files });
    });

    function uploadFile(input) {
        var file = input.files[0];
        if (!file) return;
        if (file.size > 5 * 1024 * 1024) { alert('Max 5MB'); return; }

        var fd = new FormData();
        fd.append('image', file);
        fd.append('csrf_token', '{{ csrf_token() }}');

        fetch('{{ url_for("announcement.upload_image") }}', { method: 'POST', body: fd })
            .then(function (r) { return r.json(); })
            .then(function (d) {
                if (d.success) {
                    document.getElementById('imageUrlInput').value = d.url;
                    document.getElementById('imageSection').innerHTML = '<div class="image-preview-box" id="previewBox"><img src="' + d.url + '" alt="Image"><button type="button" class="remove-img" onclick="removeImage()"><i class="bi bi-x"></i></button></div><input type="file" id="fileInput" accept="image/*" style="display:none" onchange="uploadFile(this)">';
                } else {
                    alert(d.error || 'Upload failed');
                }
            });
    }

    function removeImage() {
        document.getElementById('imageUrlInput').value = '';
        document.getElementById('imageSection').innerHTML = '<div class="upload-zone" id="dropZone" onclick="document.getElementById(\'fileInput\').click()"><i class="bi bi-cloud-arrow-up"></i><h4>Drop image here or click to upload</h4><p>PNG, JPG, GIF, WEBP (max 5MB)</p></div><input type="file" id="fileInput" accept="image/*" style="display:none" onchange="uploadFile(this)">';
        var dz = document.getElementById('dropZone');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(function (e) {
            dz.addEventListener(e, function (ev) { ev.preventDefault(); ev.stopPropagation(); });
        });
        dz.addEventListener('dragover', function () { this.classList.add('dragover'); });
        dz.addEventListener('dragleave', function () { this.classList.remove('dragover'); });
        dz.addEventListener('drop', function (e) {
            this.classList.remove('dragover');
            if (e.dataTransfer.files.length) uploadFile({ files: e.dataTransfer.files });
        });
    }
</script>
{% endblock %}